/**
 * Scanner Generator - Generate .claude/ artifacts from scan results
 */

import type { ScanResult } from './types.js';

/** Marker for start of claudeops managed section */
export const MANAGED_START = '<!-- claudeops:managed:start -->';

/** Marker for end of claudeops managed section */
const MANAGED_END = '<!-- claudeops:managed:end -->';

/**
 * Generate project-level CLAUDE.md content from scan results
 */
export function generateProjectClaudeMd(scan: ScanResult): string {
  const lines: string[] = [MANAGED_START, ''];

  lines.push('# Project Configuration');
  lines.push('');
  lines.push(`<!-- Auto-generated by claudeops from scanning ${scan.root} -->`);
  lines.push('');

  // Build commands
  if (scan.build) {
    lines.push('## Build & Test');
    lines.push('');
    lines.push(`**Build tool:** ${scan.build.tool}`);
    lines.push('');
    if (Object.keys(scan.build.scripts).length > 0) {
      lines.push('```bash');
      for (const [name, script] of Object.entries(scan.build.scripts)) {
        lines.push(`# ${name}: ${script}`);
      }
      lines.push('```');
      lines.push('');
    }
  }

  // Frameworks
  if (scan.frameworks.length > 0) {
    lines.push('## Frameworks');
    lines.push('');
    for (const fw of scan.frameworks) {
      lines.push(`- ${fw.name}${fw.version ? ` v${fw.version}` : ''}`);
    }
    lines.push('');
  }

  // Testing
  if (scan.testing.length > 0) {
    lines.push('## Testing');
    lines.push('');
    for (const t of scan.testing) {
      lines.push(`- ${t.framework}${t.configFile ? ` (${t.configFile})` : ''}`);
    }
    lines.push('');
  }

  // Linting
  if (scan.linting.length > 0) {
    lines.push('## Linting');
    lines.push('');
    for (const l of scan.linting) {
      lines.push(`- ${l.tool} (${l.configFile})`);
    }
    lines.push('');
  }

  lines.push(MANAGED_END);
  return lines.join('\n');
}

/**
 * Generate project-level settings.json from scan results
 * Returns null if no permissions need to be added
 */
export function generateProjectSettings(scan: ScanResult): Record<string, unknown> | null {
  const allow: string[] = [];

  // Add build script permissions
  if (scan.build) {
    for (const name of Object.keys(scan.build.scripts)) {
      const tool = scan.build.source.includes('package.json') ? 'npm' : scan.build.tool;
      allow.push(`${tool} run ${name}`);
    }
  }

  // Add test framework permissions
  for (const t of scan.testing) {
    allow.push(`${t.framework} **`);
  }

  if (allow.length === 0) return null;

  return {
    permissions: { allow },
  };
}

/**
 * Splice new managed content into existing CLAUDE.md
 * Returns null if splice failed
 */
export function spliceManagedSection(existing: string, newContent: string): string | null {
  const startIdx = existing.indexOf(MANAGED_START);
  const endIdx = existing.indexOf(MANAGED_END);

  if (startIdx === -1 || endIdx === -1) {
    return null;
  }

  const before = existing.substring(0, startIdx);
  const after = existing.substring(endIdx + MANAGED_END.length);

  return before + newContent + after;
}
